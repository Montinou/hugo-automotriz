<?xml version="1.0" encoding="UTF-8"?>
<prompt>
  <metadata>
    <title>Database Schema Design - Hugo Automotriz</title>
    <phase>2</phase>
    <difficulty>high</difficulty>
    <estimated_time>60-90 minutes</estimated_time>
    <version>1.0</version>
    <last_updated>2025-11-19</last_updated>
    
    <prerequisites>
      <prerequisite>01_setup_architecture.xml completed</prerequisite>
      <prerequisite>Drizzle ORM installed</prerequisite>
    </prerequisites>
  </metadata>

  <thinking_configuration>
    <claude_extended_thinking>
      <enabled>true</enabled>
      <reasoning>
        Designing a relational database schema for a multi-role platform (Drivers, Mechanics, Workshops) requires careful consideration of relationships, data integrity, and future scalability. 
        We need to handle complex scenarios like real-time assistance requests and workshop bookings.
      </reasoning>
      <budget_tokens>15000</budget_tokens>
      <expected_thinking_depth>
        Analyze the entity relationships:
        - User roles (Single table vs multiple tables?)
        - Workshop vs Mechanic relationship
        - The lifecycle of an Assistance Request (Status transitions)
        - Booking availability logic
      </expected_thinking_depth>
    </claude_extended_thinking>
  </thinking_configuration>

  <context>
    <project_info>
      <name>Hugo Automotriz</name>
      <framework>Next.js 15</framework>
      <database>NeonDB (PostgreSQL)</database>
    </project_info>

    <objective>
      <primary>
        Design and implement the complete database schema using Drizzle ORM. 
        The schema must support all core functionalities: User management, Vehicle tracking, Workshop directory, Service bookings, and Emergency assistance.
      </primary>
      <success_criteria>
        <criterion>✅ All entities defined in `src/db/schema.ts`</criterion>
        <criterion>✅ Relationships correctly established (Foreign Keys)</criterion>
        <criterion>✅ Enums used for fixed values (Status, Role, ServiceType)</criterion>
        <criterion>✅ Migrations generated successfully</criterion>
      </success_criteria>
    </objective>
  </context>

  <instructions>
    <step number="1">
      <title>Define Enums &amp; Shared Types</title>
      <thinking_guidance>
        Identify all categorical data that should be strictly typed.
        - Roles: driver, mechanic, workshop_owner, admin
        - Request Status: pending, accepted, in_progress, completed, cancelled
        - Service Types: tow, battery, tire, fuel, mechanic, maintenance
      </thinking_guidance>
      <action>
        Create PostgreSQL enums in Drizzle for: `userRoleEnum`, `requestStatusEnum`, `appointmentStatusEnum`.
      </action>
    </step>

    <step number="2">
      <title>Create User &amp; Profile Tables</title>
      <thinking_guidance>
        Decide on the user model. A single `users` table with a role column is usually best for auth.
        Additional profile details can be in the same table or separate if they diverge significantly.
        For this MVP, a single `users` table with nullable fields for specific roles (e.g., `licenseNumber` for mechanics) might be simplest, or separate `profiles` tables.
        Let's go with a unified `users` table for authentication and basic info, and separate tables for `workshops` linked to an owner.
      </thinking_guidance>
      <content>
        <![CDATA[
// Example structure
export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  email: text('email').notNull().unique(),
  role: userRoleEnum('role').default('driver'),
  fullName: text('full_name'),
  phone: text('phone'),
  // ... other fields
});
        ]]>
      </content>
    </step>

    <step number="3">
      <title>Define Core Entities (Vehicles, Workshops, Services)</title>
      <thinking_guidance>
        - `vehicles`: Belongs to a User. Needs make, model, year, plate, vin.
        - `workshops`: Belongs to a User (Owner). Needs location (lat/long), address, name, description.
        - `workshop_services`: Many-to-Many or One-to-Many? A workshop offers specific services with prices.
      </thinking_guidance>
      <action>
        Implement `vehicles`, `workshops`, and `services` tables.
        Note: `workshops` should have geolocation fields.
      </action>
    </step>

    <step number="4">
      <title>Implement Operational Tables (Requests, Appointments, Reviews)</title>
      <thinking_guidance>
        - `assistance_requests`: The core of the "Uber-like" feature. Needs user_id, provider_id (nullable initially), location, type, status.
        - `appointments`: For workshop bookings. Needs workshop_id, vehicle_id, date, status.
        - `reviews`: Polymorphic or separate? Let's do `workshop_reviews` and `mechanic_reviews` if needed, or a generic `reviews` table.
      </thinking_guidance>
      <action>
        Create `assistance_requests`, `appointments`, and `reviews` tables.
        Ensure timestamps (created_at, updated_at) are present on all tables.
      </action>
    </step>

    <step number="5">
      <title>Generate &amp; Run Migrations</title>
      <thinking_guidance>
        Verify the schema definition before pushing.
      </thinking_guidance>
      <commands>
        <![CDATA[
npx drizzle-kit generate
npx drizzle-kit migrate
        ]]>
      </commands>
    </step>
  </instructions>

  <validation>
    <thinking_quality>
      <criteria>
        <criterion>Schema handles the "hybrid" nature (Emergency vs Scheduled) effectively</criterion>
        <criterion>Geolocation data structure is standard (lat/lng)</criterion>
      </criteria>
    </thinking_quality>
    <execution_checklist>
      <item>✅ `schema.ts` compiles without type errors</item>
      <item>✅ Database tables created in NeonDB</item>
      <item>✅ Relationships (FKs) are enforced in the database</item>
    </execution_checklist>
  </validation>

  <output_format>
    <structure>
      <section name="schema_diagram">Mermaid diagram or text description of relationships</section>
      <section name="sql_output">Result of the migration run</section>
    </structure>
    <format>Markdown</format>
  </output_format>
</prompt>
