<?xml version="1.0" encoding="UTF-8"?>
<prompt>
  <metadata>
    <title>AI Features Implementation - Vercel AI Gateway</title>
    <phase>7</phase>
    <difficulty>high</difficulty>
    <estimated_time>60-90 minutes</estimated_time>
    <version>1.0</version>
    <last_updated>2025-11-19</last_updated>
    
    <prerequisites>
      <prerequisite>06_ui_dashboards.xml completed</prerequisite>
      <prerequisite>Vercel AI SDK installed</prerequisite>
      <prerequisite>OpenAI or Anthropic API Key</prerequisite>
    </prerequisites>
  </metadata>

  <thinking_configuration>
    <claude_extended_thinking>
      <enabled>true</enabled>
      <reasoning>
        Integrating AI requires handling streaming responses, managing context (vehicle history), and ensuring reliability. 
        Vercel AI Gateway provides caching and observability, which is crucial for cost control and performance in a production app.
        We need to design the "AI Mechanic" chat interface and the background analysis jobs.
      </reasoning>
      <budget_tokens>12000</budget_tokens>
      <expected_thinking_depth>
        Design the prompt engineering strategy for "Predictive Maintenance".
        Plan the architecture for the "AI Mechanic" chatbot (Streaming UI).
        Configure Vercel AI Gateway for caching common queries (e.g., "Maintenance schedule for Toyota Corolla 2020").
      </expected_thinking_depth>
    </claude_extended_thinking>
  </thinking_configuration>

  <context>
    <project_info>
      <name>Hugo Automotriz</name>
      <framework>Next.js 15</framework>
      <ai_stack>Vercel AI SDK, Vercel AI Gateway</ai_stack>
    </project_info>

    <objective>
      <primary>
        Implement intelligent features using Vercel AI SDK.
        1. **AI Mechanic Chatbot**: Helps users diagnose issues and estimate costs.
        2. **Predictive Maintenance**: Analyzes vehicle data to suggest services.
        3. **Workshop Insights**: Generates natural language reports for workshop owners.
        **CRITICAL**: AI must interact in Spanish and be aware of the Bolivian context (e.g., terrain, common car models in Bolivia, currency in Bs).
      </primary>
      <success_criteria>
        <criterion>✅ Chatbot streams responses fluently in Spanish</criterion>
        <criterion>✅ Vercel AI Gateway is configured (caching enabled)</criterion>
        <criterion>✅ Predictive maintenance uses vehicle context correctly</criterion>
      </success_criteria>
    </objective>
  </context>

  <instructions>
    <step number="1">
      <title>Setup Vercel AI SDK &amp; Gateway</title>
      <thinking_guidance>
        Install `ai` and `@ai-sdk/openai` (or anthropic).
        Configure the API route `src/app/api/chat/route.ts`.
        Set up Vercel AI Gateway headers/config for caching and rate limiting.
      </thinking_guidance>
      <commands>
        <![CDATA[
npm install ai @ai-sdk/openai zod
        ]]>
      </commands>
      <action>
        Create `src/lib/ai.ts` to configure the model provider.
        Implement the standard route handler for streaming text.
      </action>
    </step>

    <step number="2">
      <title>Implement "AI Mechanic" Chat Interface</title>
      <thinking_guidance>
        Create a floating chat widget or a dedicated page `src/app/dashboard/mechanic-ai/page.tsx`.
        Use `useChat` hook from Vercel AI SDK.
        The system prompt must define the persona: "Mecánico Experto, servicial, consciente de la seguridad. Habla español de Bolivia (neutro pero amigable).".
        It should have access to the user's selected vehicle details via context.
      </thinking_guidance>
      <action>
        Create `ChatInterface.tsx` with message bubbles (User vs AI).
        Pass `body: { vehicleId }` in the chat request to inject context.
      </action>
    </step>

    <step number="3">
      <title>Implement Predictive Maintenance Analysis</title>
      <thinking_guidance>
        This is likely a "Generate Object" task using `streamObject` or `generateObject`.
        Input: Vehicle Make, Model, Year, Mileage, Last Service Date.
        Output: JSON list of recommended services with urgency levels.
      </thinking_guidance>
      <action>
        Create a Server Action `analyzeMaintenance(vehicleId)`.
        It fetches vehicle data, sends prompt to AI, and returns structured JSON.
        Display results in a "Vehicle Health" card on the dashboard.
      </action>
    </step>

    <step number="4">
      <title>Implement Cost Estimator</title>
      <thinking_guidance>
        Allow the user to ask "How much for a brake pad replacement?".
        The AI should provide a range based on general data, but clarify it's an estimate.
        Ideally, it could RAG (Retrieval Augmented Generation) against the platform's average prices if we had that data.
        For now, use general knowledge with a disclaimer.
      </thinking_guidance>
      <action>
        Integrate this capability into the main Chatbot or a specific "Get Estimate" form.
      </action>
    </step>
  </instructions>

  <validation>
    <execution_checklist>
      <item>✅ Chatbot responds to automotive questions</item>
      <item>✅ Predictive analysis returns valid JSON structure</item>
      <item>✅ AI Gateway logs show successful requests</item>
    </execution_checklist>
  </validation>

  <output_format>
    <structure>
      <section name="ai_config">Configuration details</section>
    </structure>
    <format>Markdown</format>
  </output_format>
</prompt>
