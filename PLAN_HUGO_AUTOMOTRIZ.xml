<?xml version="1.0" encoding="UTF-8"?>
<prompt>
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- SECCIÓN 1: METADATA                                                      -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->

  <metadata>
    <title>Mejoras Críticas Hugo Automotriz: Geolocalización, Tickets y AI</title>
    <phase>Optimization &amp; Fixes</phase>
    <difficulty>high</difficulty>
    <estimated_time>3-4 horas</estimated_time>
    <version>1.0</version>
    <last_updated>2025-11-20</last_updated>

    <prerequisites>
      <prerequisite>Acceso a base de datos (Neon/Postgres)</prerequisite>
      <prerequisite>API Key de OpenAI configurada</prerequisite>
      <prerequisite>Google Maps API Key (para geocoding reverso si es necesario)</prerequisite>
    </prerequisites>
  </metadata>

  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- SECCIÓN 2: THINKING CONFIGURATION                                        -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->

  <thinking_configuration>
    <claude_extended_thinking>
      <enabled>true</enabled>
      <reasoning>
        Esta tarea implica modificar flujos críticos de negocio (solicitud de servicio, asignación de talleres) y arreglar integraciones fallidas (AI, base de datos). Requiere analizar por qué fallan las implementaciones actuales y diseñar una arquitectura robusta para la geolocalización y el sistema de tickets en tiempo real.
      </reasoning>
      <budget_tokens>15000</budget_tokens>
      <expected_thinking_depth>
        Análisis de causa raíz para los bugs de registro y AI. Diseño de arquitectura para el sistema de tickets (polling vs sockets vs server actions) y flujo de estados de solicitud.
      </expected_thinking_depth>
    </claude_extended_thinking>
  </thinking_configuration>

  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- SECCIÓN 3: CONTEXTO                                                      -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->

  <context>
    <project_info>
      <name>Hugo Automotriz</name>
      <current_location>/Users/agustinmontoya/Projectos/hugo-automotriz</current_location>
      <framework>Next.js 14 (App Router)</framework>
      <status>En desarrollo - Fixes críticos requeridos</status>
    </project_info>

    <objective>
      <primary>
        Arreglar funcionalidades rotas (Registro Vehicular, AI) e implementar el flujo real de solicitud de asistencia con geolocalización automática y un sistema de tickets para talleres, eliminando los mockups actuales.
      </primary>

      <success_criteria>
        <criterion>✅ Registro de vehículos funciona correctamente y persiste en DB.</criterion>
        <criterion>✅ Chat de Asistencia IA responde correctamente con contexto del vehículo.</criterion>
        <criterion>✅ Solicitud de asistencia captura lat/long automáticamente del navegador.</criterion>
        <criterion>✅ Talleres pueden ver y "tomar" tickets de asistencia en su dashboard.</criterion>
        <criterion>✅ Conductores ven estado real de su solicitud (Pendiente -> En camino).</criterion>
        <criterion>✅ Conductores pueden calificar el servicio al finalizar.</criterion>
      </success_criteria>
    </objective>
  </context>

  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- SECCIÓN 7: INSTRUCTIONS                                                  -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->

  <instructions>
    <step number="1">
      <title>Arreglar Registro de Vehículos</title>
      <thinking_guidance>
        Analiza `src/app/actions/driver.ts` y `VehicleManager.tsx`. El usuario reporta que no funciona.
        1. Verifica que los datos del formulario lleguen correctamente al Server Action.
        2. Verifica que el usuario esté autenticado y exista en la tabla `users`.
        3. Agrega manejo de errores robusto y logs para identificar la falla.
        4. Asegura que `revalidatePath` actualice la UI.
      </thinking_guidance>
      <action>
        Depurar y corregir `addVehicle` en `src/app/actions/driver.ts`. Agregar validación de datos con Zod si es necesario. Verificar la llamada en `VehicleManager.tsx`.
      </action>
      <validation>
        <execution_success>
          ✅ Nuevo vehículo aparece en la lista después de enviar el formulario.
          ✅ No hay errores en consola.
        </execution_success>
      </validation>
    </step>

    <step number="2">
      <title>Arreglar Asistencia Vehicular con IA</title>
      <thinking_guidance>
        El chat IA no funciona. Analiza `src/app/api/chat/route.ts` y `ChatInterface.tsx`.
        1. Verifica la configuración de `openai` en `src/lib/ai.ts`.
        2. Revisa el paso de mensajes y `vehicleContext`.
        3. Asegura que el modelo `gpt-4o-mini` sea accesible con la API Key actual.
        4. Verifica que el stream de respuesta se maneje correctamente en el cliente.
      </thinking_guidance>
      <action>
        Corregir la integración de Vercel AI SDK. Verificar API Key y modelo. Asegurar que `vehicleContext` se inyecte correctamente en el prompt del sistema.
      </action>
    </step>

    <step number="3">
      <title>Implementar Geolocalización Automática</title>
      <thinking_guidance>
        Necesitamos capturar la ubicación del conductor al solicitar asistencia.
        1. Crear un hook `useGeolocation` o usar `navigator.geolocation` directamente en el formulario de solicitud.
        2. Modificar la tabla `assistance_requests` (ya tiene lat/long, verificar tipos).
        3. Al crear el request, enviar las coordenadas reales.
      </thinking_guidance>
      <action>
        Crear componente/hook para capturar ubicación. Actualizar formulario de solicitud para incluir lat/long ocultos o automáticos.
      </action>
    </step>

    <step number="4">
      <title>Implementar Sistema de Tickets para Talleres</title>
      <thinking_guidance>
        Reemplazar el mockup de "Ayuda en camino".
        1. Crear vista "Bolsa de Tickets" en Dashboard Taller (`src/app/dashboard/workshop/tickets/page.tsx`).
        2. Mostrar requests con status `pending`.
        3. Implementar acción `acceptRequest(ticketId)` que asigne el `providerId` al taller/mecánico y cambie status a `accepted`.
        4. Actualizar la vista del conductor para que haga polling o escuche cambios de estado (de `pending` a `accepted`).
      </thinking_guidance>
      <action>
        Crear página de tickets para talleres. Implementar Server Action `acceptRequest`. Modificar `TrackingView` para mostrar estado real ("Buscando taller..." vs "Taller X en camino").
      </action>
    </step>

    <step number="5">
      <title>Implementar Calificación de Talleres</title>
      <thinking_guidance>
        Permitir al conductor calificar el servicio al finalizar.
        1. Cuando el status sea `completed`, mostrar modal de calificación en la vista del conductor.
        2. Crear Server Action `submitReview` que inserte en tabla `reviews` y actualice el promedio en `workshops`.
      </thinking_guidance>
      <action>
        Crear componente de Rating (estrellas). Implementar lógica de envío de reseña y actualización de promedios.
      </action>
    </step>
  </instructions>

  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- SECCIÓN 8: VALIDATION                                                    -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->

  <validation>
    <execution_checklist>
      <item>✅ Registro de vehículo agrega el auto a la base de datos y refresca la lista.</item>
      <item>✅ Chat IA responde preguntas sobre mecánica con contexto del auto seleccionado.</item>
      <item>✅ Solicitud de asistencia guarda latitud y longitud precisas del usuario.</item>
      <item>✅ Taller ve la solicitud en su dashboard y puede aceptarla.</item>
      <item>✅ Conductor ve cuando el taller acepta la solicitud (cambio de estado UI).</item>
      <item>✅ Conductor puede dejar una reseña (1-5 estrellas) al finalizar el servicio.</item>
    </execution_checklist>
  </validation>

</prompt>
